{% include "includes/head.html" %}
{% include "includes/header.html" %}

{% csrf_token %}

<main>
	<div class="container-fluid">
		<p><a href="/posts">Back to posts</a></p>
		<div class="panel panel-primary">

            <!-- Header contains title and date -->
			<div class="panel-heading clearfix">
				<h3 class="panel-title pull-left">{{ post.title }}</h3>
                <span class="pull-right">Event Date: {{ post.event_date }} | Submission Date: {{ post.sub_date }} | Location: {{ post.location }}</span>
			</div>


            <!-- Body contains text, url, and tags -->
			<div class="panel-body">
				<p>{{ post.text }}</p>
				{% if post.url %}
					<a href="{{ post.url }}">External Link</a>
				{% endif %}

				{% if post.photo %}
                    {% if post.photo.url %}
                        <img src="{{ post.photo.url }}">
                    {% endif %}
				{% endif %}

                <hr/>
                <p id="new-tagger">
                    <p><span>Add Tags: </span><span id="warning"></span></p>
                    <input id="new-tag-field" maxlength="16" name="title" type="text"/>
                    <button id="new-tag-button">Add</button>
                </p>

                <hr/>
                    Tags:     
                    {% if tags != None %}
                        <div id="visible-tag-list">
                            {% for tag in tags %}
                                {% if tag != None %}
                                    <div class="unvoted-tag update-tag" value="{{ tag.title }}">{{ tag.title }}
                                        (<div class="update-tag-votes">{{ tag.votes }}</div>)
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
			</div>

            <!-- Footer contains post type -->
			<div class="panel-footer">
				{{ post.get_post_type_display }}
			</div> 

		</div>
	</div>
</main>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

<script>
    $(document).ready(function() {
        tagList = {{ tag_titles|safe }}; 
        created = 0;

        $('.unvoted-tag').click(function() {
            vote($(this));
            return false;
        });

        $('.voted-tag').click(function() {
            unvote($(this));
            return false;
        });

        function vote(curTag) {
            // Now onclick will trigger unvoting
            curTag.unbind();
            curTag.bind('click', function () { unvote(curTag); });

            // Indicate the tag has been voted on by its classes
            curTag.removeClass('unvoted-tag');
            curTag.addClass('voted-tag');

            // Update the displayed number of votes
            var newVotes = parseInt(curTag.find('>:first-child').text()) + 1;
            curTag.find('>:first-child').text(newVotes);

            // Grabs the tag's text
            var tag_title = curTag.context.getAttribute('value');
            
            // Updates the tag's number of votes in the Django backend
            $.ajax({
                type:'POST',
                url:'../tags/vote/{{ post.id }}/' + tag_title,
            }); 
        }

        function unvote(curTag) {
            // Now onclick will trigger unvoting
            curTag.unbind();
            curTag.bind('click', function () { vote(curTag); });

            // Indicate the tag has been voted on by its classes
            curTag.removeClass('voted-tag');
            curTag.addClass('unvoted-tag');

            // Update the displayed number of votes
            var newVotes = parseInt(curTag.find('>:first-child').text()) - 1;
            curTag.find('>:first-child').text(newVotes);

            // Grabs the tag's text
            var tag_title = curTag.context.getAttribute('value');

            // Updates the tag's number of votes in the Django backend
            $.ajax({
                type:'POST',
                url:'../tags/unvote/{{ post.id }}/' + tag_title,
            }); 
        }

        // Adds csrf token so we can update a tag's votes in the Django backend
        $.ajaxSetup({data: {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }});

        // When we add a tag
        $('#new-tag-button').click(function(e) {
            // Grabs the new tag text and clears spaces
            var newTagTitle = $('#new-tag-field').val().replace(/\W/g, '');

            if (newTagTitle.length == 0) {
                $('#warning').text('Please enter a tag below');
            } else if (tagList.indexOf(newTagTitle) != -1) {
                $('#warning').text('You\'ve already used that tag!');
            } else {
                tagList.push(newTagTitle);
                created++;

                // Add to the displayed visible tag list
                $('#visible-tag-list').append('<div id=\"new-' + created + '\"class=\"voted-tag update-tag\" value=\"' + newTagTitle + '\">' + newTagTitle + ' (<div class=\"update-tag-votes\">1</div>)</div>');
                var curTag = $('#new-' + created);
                curTag.context = curTag[0];
                curTag.bind('click', function () { unvote(curTag); });

                $.ajax({
                    type:'POST',
                    url:'../tags/create/{{ post.id }}/' + newTagTitle,
                }); 

                // Display success message
                $('#warning').text('Tag submitted');
            }

            $('#new-tag-field').val('');
            return false;
        });
    });
</script> 
